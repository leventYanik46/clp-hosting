---
import type { InferGetStaticPropsType, GetStaticPaths } from 'astro';

import merge from 'lodash.merge';
import type { ImageMetadata } from 'astro';
import Layout from '~/layouts/PageLayout.astro';
import SinglePost from '~/components/blog/SinglePost.astro';
import ToBlogLink from '~/components/blog/ToBlogLink.astro';

import { getStaticPathsBlogPost, blogPostRobots } from '~/utils/blog';
import { findImage } from '~/utils/images';
import type { MetaData, SeoData } from '~/types';
import RelatedPosts from '~/components/blog/RelatedPosts.astro';
import {
  buildLanguageAlternatesForLangs,
  DEFAULT_SEO_LANG,
  getAlternateOgLocalesForLangs,
  getOgLocaleForLang,
  sanitizeCanonicalUrl,
} from '~/data/seo';

export const prerender = true;

export const getStaticPaths = (async () => {
  return await getStaticPathsBlogPost();
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post, lang } = Astro.props as Props;
const seoLang = ['en', 'tr', 'es', 'pt', 'fr'].includes(lang) ? (lang as 'en' | 'tr' | 'es' | 'pt' | 'fr') : 'en';
const siteUrl = String(Astro.site ?? 'https://capitollawpartners.com');
const siteHost = new URL(siteUrl).hostname;

const generatedCanonical =
  sanitizeCanonicalUrl(Astro.url.pathname, {
    siteUrl,
    forceHost: siteHost,
  }) ??
  sanitizeCanonicalUrl(String(Astro.url.href), {
    siteUrl,
    forceHost: siteHost,
  });
const canonical = generatedCanonical || String(new URL(Astro.url.pathname, siteUrl));
const image = (await findImage(post.image)) as ImageMetadata | string | undefined;
const imageSource = typeof image === 'string' ? image : image?.src;
const imageUrl = imageSource ? new URL(imageSource, siteUrl).toString() : undefined;
const postLangValues = Array.isArray(post.lang)
  ? post.lang
  : typeof post.lang === 'string'
    ? [post.lang]
    : [seoLang];
const routePath = `/${post.permalink}`;
const languageAlternates = buildLanguageAlternatesForLangs(
  routePath,
  siteUrl,
  postLangValues,
  DEFAULT_SEO_LANG,
  false
);
const ogLocaleAlternates = getAlternateOgLocalesForLangs(seoLang, postLangValues, false);

const sanitizedPostMetadata = post?.metadata
  ? {
      ...post.metadata,
      ...(post.metadata.description ? { description: post.metadata.description.trim() } : {}),
      canonical,
    }
  : { canonical };

const metadata = merge(
  {
    title: post.title,
    description: post.excerpt,
    robots: {
      index: blogPostRobots?.index,
      follow: blogPostRobots?.follow,
    },
    openGraph: {
      type: 'article',
      locale: getOgLocaleForLang(seoLang),
      ...(image
        ? { images: [{ url: image, width: (image as ImageMetadata)?.width, height: (image as ImageMetadata)?.height }] }
        : {}),
    },
  },
  sanitizedPostMetadata
) as MetaData;

const seo: SeoData = {
  title: post.metadata?.title ?? post.title,
  description: post.metadata?.description ?? post.excerpt,
  ogImage: imageSource,
  noindex: blogPostRobots?.index === false,
  nofollow: blogPostRobots?.follow === false,
  canonicalOverride: canonical,
  schema: {
    mode: 'merge',
    includeBreadcrumbs: true,
  },
};
---

<Layout
  metadata={metadata}
  seo={seo}
  pageType="article"
  article={{
    title: post.title,
    description: (metadata.description || post.excerpt || '').trim(),
    image: imageUrl,
    datePublished: post.publishDate?.toISOString?.(),
    dateModified: (post.updateDate || post.publishDate)?.toISOString?.(),
    authorName: post.author,
    articleSection: post.category?.title,
    keywords: post.tags?.map((tag) => tag.title),
  }}
  languageAlternates={languageAlternates}
  ogLocaleAlternates={ogLocaleAlternates}
>
  <SinglePost post={{ ...post, image: image }} url={canonical}>
    {post.Content ? <post.Content /> : <Fragment set:html={post.content || ''} />}
  </SinglePost>
  <ToBlogLink lang={lang} />
  <RelatedPosts post={post} lang={lang} />
</Layout>
