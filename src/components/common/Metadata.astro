---
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import { SITE, METADATA } from 'astrowind:config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';

import { adaptOpenGraphImages } from '~/utils/images';
import {
  buildLanguageAlternates,
  getAlternateOgLocales,
  getLangFromPathname,
  getOgLocaleForLang,
  type HreflangAlternate,
  sanitizeCanonicalUrl,
} from '~/data/seo';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
  languageAlternates?: HreflangAlternate[];
  ogLocaleAlternates?: string[];
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical: canonicalOverride,
  robots = {},
  description,
  openGraph = {},
  twitter = {},
  languageAlternates: languageAlternatesOverride = undefined,
  ogLocaleAlternates: ogLocaleAlternatesOverride = undefined,
} = Astro.props;

const siteUrl = String(Astro.site ?? SITE?.site ?? 'https://capitollawpartners.com');
const siteHost = new URL(siteUrl).hostname;
const generatedCanonical = String(getCanonical(String(Astro.url.pathname)));
const canonical =
  sanitizeCanonicalUrl(canonicalOverride ?? generatedCanonical, {
    siteUrl,
    forceHost: siteHost,
  }) ?? generatedCanonical;

const routeLang = getLangFromPathname(Astro.url.pathname);
const routeOgLocale = getOgLocaleForLang(routeLang);
const ogLocaleAlternates = ogLocaleAlternatesOverride ?? getAlternateOgLocales(routeLang);
const languageAlternates = languageAlternatesOverride ?? buildLanguageAlternates(Astro.url.pathname, siteUrl);

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [],
      locale: routeOgLocale,
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description,
    openGraph: METADATA?.openGraph,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: {
      ...openGraph,
      url: canonical,
      locale: openGraph?.locale ?? routeOgLocale,
    },
    twitter: twitter,
    languageAlternates,
  }
);
---

<AstroSeo {...{ ...seoProps, openGraph: await adaptOpenGraphImages(seoProps?.openGraph, Astro.site) }} />
{ogLocaleAlternates.map((locale) => <meta property="og:locale:alternate" content={locale} />)}
